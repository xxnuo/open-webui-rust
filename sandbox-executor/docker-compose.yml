version: '3.8'

services:
  # Build the runtime container first
  sandbox-runtime:
    build:
      context: .
      dockerfile: Dockerfile.runtime
    image: sandbox-runtime:latest
    # image: public.ecr.aws/o3p7x2f5/knoxchat/sandbox-runtime:latest
    container_name: sandbox-runtime
    command: /bin/true  # Just builds the image

  # The sandbox executor service
  sandbox-executor:
    build:
      context: .
      dockerfile: Dockerfile
    image: sandbox-executor:latest
    # image: public.ecr.aws/o3p7x2f5/knoxchat/sandbox-executor:latest
    container_name: sandbox-executor
    user: root  # Needs root to access Docker socket
    ports:
      - "8090:8090"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./logs:/var/log/sandbox-executor
    environment:
      - SANDBOX_HOST=0.0.0.0
      - SANDBOX_PORT=8090
      - DOCKER_HOST=unix:///var/run/docker.sock
      - MAX_EXECUTION_TIME=60
      - MAX_MEMORY_MB=512
      - MAX_CPU_QUOTA=100000
      - MAX_DISK_MB=100
      - MAX_CONCURRENT_EXECUTIONS=10
      - RATE_LIMIT_PER_MINUTE=30
      - RATE_LIMIT_BURST=10
      - CONTAINER_IMAGE=sandbox-runtime:latest
      - NETWORK_MODE=none
      - READ_ONLY_ROOT=false
      - DROP_ALL_CAPABILITIES=true
      - ENABLE_STREAMING=true
      - KEEP_CONTAINERS=false
      - ENABLE_PYTHON=true
      - ENABLE_JAVASCRIPT=true
      - ENABLE_SHELL=true
      - ENABLE_RUST=true
      - ENABLE_AUDIT_LOG=true
      - AUDIT_LOG_PATH=/var/log/sandbox-executor/audit.log
    depends_on:
      - sandbox-runtime
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8090/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - sandbox-network

networks:
  sandbox-network:
    driver: bridge

volumes:
  sandbox-logs:

